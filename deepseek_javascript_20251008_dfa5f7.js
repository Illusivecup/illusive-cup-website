// js/app.js
import AppConfig from './config/app-config.js';
import ErrorHandler from './utils/error-handler.js';
import PerformanceOptimizer from './utils/performance-optimizer.js';
import { AppState } from './utils/state-manager.js';
import { firebaseService } from './services/firebase-service.js';
import { securityService } from './services/security-service.js';
import { teamsManager } from './managers/teams-manager.js';
import { tournamentManager } from './managers/tournament-manager.js';
import UIManager from './ui/ui-manager.js';

export class TournamentApp {
    constructor() {
        this.isInitialized = false;
        this.modules = new Map();
        this.uiManager = null;
    }

    async initialize() {
        try {
            console.log('ğŸš€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Illusive Cup Tournament App...');

            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚
            await this.initializeSystem();
            
            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
            await this.initializeServices();
            
            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²
            await this.initializeManagers();
            
            // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ UI
            await this.initializeUI();
            
            // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            await this.loadInitialData();
            
            // Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°
            await this.finalizeInitialization();

            this.isInitialized = true;
            console.log('âœ… Tournament App ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');

        } catch (error) {
            console.error('ğŸ’¥ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', error);
            await this.handleFatalError(error);
        }
    }

    async initializeSystem() {
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
        ErrorHandler.init();

        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        PerformanceOptimizer.init();

        // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
        this.setupGlobalHandlers();

        console.log('âœ… Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹');
    }

    async initializeServices() {
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Firebase
        await firebaseService.initialize();
        this.modules.set('firebase', firebaseService);

        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
        await securityService.initialize();
        this.modules.set('security', securityService);

        // ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
        firebaseService.onConnectionChange((connected) => {
            this.handleConnectionChange(connected);
        });

        console.log('âœ… Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹');
    }

    async initializeManagers() {
        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
        await teamsManager.initialize();
        this.modules.set('teams', teamsManager);

        // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ° Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğ°
        await tournamentManager.initialize();
        this.modules.set('tournament', tournamentManager);

        console.log('âœ… ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹');
    }

    async initializeUI() {
        this.uiManager = new UIManager();
        await this.uiManager.initialize();
        this.modules.set('ui', this.uiManager);

        console.log('âœ… UI Manager Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
    }

    async loadInitialData() {
        try {
            // ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            await PerformanceOptimizer.preloadCriticalData([
                { 
                    promise: teamsManager.getAllTeams(), 
                    priority: 'high' 
                },
                { 
                    promise: tournamentManager.exportTournamentData(), 
                    priority: 'high' 
                }
            ]);

            // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ñ„Ğ¾Ğ½Ğµ
            this.loadBackgroundData();

            console.log('âœ… ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹');
        } catch (error) {
            console.warn('âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error);
        }
    }

    async finalizeInitialization() {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¿Ğ¾ URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼
        await this.checkURLAccess();

        // Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²
        this.startBackgroundProcesses();

        // ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
        this.trackInitializationMetrics();

        // ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
        this.notifyReady();

        console.log('ğŸ‰ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ');
    }

    setupGlobalHandlers() {
        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
        window.addEventListener('error', this.handleGlobalError.bind(this));
        window.addEventListener('unhandledrejection', this.handleUnhandledRejection.bind(this));

        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½/Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
        window.addEventListener('online', this.handleOnlineStatus.bind(this));
        window.addEventListener('offline', this.handleOfflineStatus.bind(this));

        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));

        // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ¾Ñ‚ĞµÑ€Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
        window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));

        console.log('âœ… Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹');
    }

    handleConnectionChange(connected) {
        AppState.set('connectionStatus', connected ? 'connected' : 'disconnected');
        
        if (connected) {
            ErrorHandler.showNotification({
                type: 'success',
                title: 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾',
                message: 'Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...',
                duration: 3000
            });
        } else {
            ErrorHandler.showNotification({
                type: 'warning',
                title: 'ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ',
                message: 'Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ² Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ',
                duration: 5000
            });
        }
    }

    async handleGlobalError(event) {
        console.error('ğŸ’¥ Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸:', event.error);
        
        // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
        ErrorHandler.logError(event.error, 'app_global');
        
        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        if (!this.isCriticalError(event.error)) {
            ErrorHandler.showNotification({
                type: 'error',
                title: 'ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°',
                message: 'ĞœÑ‹ ÑƒĞ¶Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ğ½Ğ°Ğ´ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼',
                duration: 5000
            });
        }
    }

    handleUnhandledRejection(event) {
        console.error('ğŸ’¥ ĞĞµĞ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğ¹ Promise:', event.reason);
        ErrorHandler.logError(event.reason, 'app_promise');
    }

    handleOnlineStatus() {
        console.log('ğŸŒ ĞĞ½Ğ»Ğ°Ğ¹Ğ½ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
        AppState.set('networkStatus', 'online');
        
        // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğº Firebase
        setTimeout(() => {
            firebaseService.initialize().catch(console.error);
        }, 1000);
    }

    handleOfflineStatus() {
        console.log('ğŸŒ ĞŸĞ¾Ñ‚ĞµÑ€ÑĞ½Ğ¾ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ');
        AppState.set('networkStatus', 'offline');
    }

    handleVisibilityChange() {
        const isVisible = document.visibilityState === 'visible';
        AppState.set('appVisible', isVisible);
        
        if (isVisible) {
            // ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ğ»Ğ¾ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğ¼ - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ
            this.checkConnection();
        }
    }

    handleBeforeUnload(event) {
        if (securityService.isAuthenticated) {
            securityService.logout('ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ğ» ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ');
        }

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        this.saveCriticalData();

        // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ½ĞµÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        if (this.hasUnsavedChanges()) {
            event.preventDefault();
            event.returnValue = 'Ğ£ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ. Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ¹Ñ‚Ğ¸?';
            return event.returnValue;
        }
    }

    async checkURLAccess() {
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        const editorMode = urlParams.get('editor');

        try {
            if (accessToken) {
                await securityService.authenticate(null, { 
                    isTemporary: true, 
                    token: accessToken 
                });
                
                // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ URL Ğ¾Ñ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
                window.history.replaceState({}, '', window.location.pathname);
                
                ErrorHandler.showNotification({
                    type: 'success',
                    title: 'Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½',
                    message: 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½ 24 Ñ‡Ğ°ÑĞ°',
                    duration: 5000
                });
            } else if (editorMode === 'true') {
                this.uiManager.showAuthModal();
            }
        } catch (error) {
            console.warn('âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ¿Ğ¾ URL:', error);
        }
    }

    loadBackgroundData() {
        // Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        PerformanceOptimizer.idleCallback(() => {
            // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
            // ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²
            // ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²
        }, 2000);
    }

    startBackgroundProcesses() {
        // ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
        setInterval(() => {
            this.backgroundSync();
        }, 30000); // ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´

        // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
        setInterval(() => {
            this.cleanupMemory();
        }, 60000); // ĞšĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
        setInterval(() => {
            this.autoSave();
        }, 30000); // ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´
    }

    async backgroundSync() {
        if (!firebaseService.isConnected) return;

        try {
            // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
            await Promise.allSettled([
                teamsManager.saveToCache(),
                // Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹...
            ]);

            // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
            this.updatePerformanceMetrics();
        } catch (error) {
            console.warn('âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', error);
        }
    }

    cleanupMemory() {
        PerformanceOptimizer.cleanup();
        
        // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞ° ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
        if (PerformanceOptimizer.getMetrics().memory_usage > 0.8) {
            console.log('ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸...');
            // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ĞºÑÑˆĞ°
        }
    }

    autoSave() {
        // ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        if (this.hasUnsavedChanges()) {
            this.saveCriticalData();
        }
    }

    trackInitializationMetrics() {
        if ('performance' in window) {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
                const metrics = {
                    loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                    domReady: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                    totalTime: perfData.loadEventEnd - perfData.navigationStart,
                    initTime: Date.now() - perfData.navigationStart
                };

                PerformanceOptimizer.trackMetric('app_initialization', metrics);
                console.log('ğŸ“Š ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', metrics);
            }
        }
    }

    notifyReady() {
        const event = new CustomEvent('app:ready', {
            detail: { 
                timestamp: Date.now(),
                version: '2.0.0'
            }
        });
        document.dispatchEvent(event);
    }

    async checkConnection() {
        try {
            const isConnected = await firebaseService.testConnection();
            AppState.set('connectionStatus', isConnected ? 'connected' : 'disconnected');
            return isConnected;
        } catch (error) {
            AppState.set('connectionStatus', 'error');
            return false;
        }
    }

    saveCriticalData() {
        try {
            // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² localStorage
            const criticalData = {
                teams: teamsManager.getAllTeams(),
                tournament: tournamentManager.exportTournamentData(),
                timestamp: Date.now()
            };

            localStorage.setItem('app_critical_data', JSON.stringify(criticalData));
        } catch (error) {
            console.warn('âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:', error);
        }
    }

    hasUnsavedChanges() {
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ½ĞµÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
        const unsavedChanges = AppState.get('unsavedChanges', false);
        return unsavedChanges === true;
    }

    isCriticalError(error) {
        const criticalErrors = [
            'FirebaseError',
            'NetworkError',
            'TypeError',
            'ReferenceError'
        ];

        return criticalErrors.some(criticalError => 
            error.name?.includes(criticalError) || 
            error.message?.includes(criticalError)
        );
    }

    async handleFatalError(error) {
        console.error('ğŸ’¥ Ğ¤Ğ°Ñ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:', error);

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
        this.saveErrorState(error);

        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞºÑ€Ğ°Ğ½ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
        ErrorHandler.showFallbackUI(error);

        // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ
        setTimeout(() => {
            this.attemptRecovery();
        }, 5000);
    }

    saveErrorState(error) {
        const errorState = {
            error: {
                message: error.message,
                stack: error.stack,
                name: error.name
            },
            appState: AppState.serialize(),
            modules: Array.from(this.modules.keys()),
            timestamp: Date.now(),
            userAgent: navigator.userAgent,
            url: window.location.href
        };

        try {
            sessionStorage.setItem('app_error_state', JSON.stringify(errorState));
        } catch (e) {
            console.warn('âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:', e);
        }
    }

    async attemptRecovery() {
        try {
            console.log('ğŸ”„ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ...');

            // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
            AppState.clear();

            // ĞŸĞµÑ€ĞµĞ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
            for (const [name, module] of this.modules) {
                if (typeof module.destroy === 'function') {
                    module.destroy();
                }
            }
            this.modules.clear();

            // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ
            await this.initialize();

        } catch (recoveryError) {
            console.error('ğŸ’¥ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ:', recoveryError);
            
            // ĞŸÑ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ
            ErrorHandler.showNotification({
                type: 'error',
                title: 'ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°',
                message: 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹',
                actions: [
                    {
                        id: 'reload',
                        label: 'ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ',
                        handler: () => window.location.reload()
                    }
                ]
            });
        }
    }

    // ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹
    getModule(name) {
        return this.modules.get(name);
    }

    getStatus() {
        return {
            initialized: this.isInitialized,
            modules: Array.from(this.modules.keys()),
            connection: firebaseService.isConnected,
            authentication: securityService.getAuthStatus(),
            performance: PerformanceOptimizer.getMetrics()
        };
    }

    async destroy() {
        console.log('ğŸ›‘ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ...');

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
        this.saveCriticalData();

        // ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
        for (const [name, module] of this.modules) {
            if (typeof module.destroy === 'function') {
                await module.destroy();
            }
        }

        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        AppState.clear();

        this.isInitialized = false;
        this.modules.clear();
        this.uiManager = null;

        console.log('âœ… ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ');
    }
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
const app = new TournamentApp();

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
window.tournamentApp = app;

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ DOM
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await app.initialize();
    } catch (error) {
        console.error('ğŸ’¥ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:', error);
        ErrorHandler.showFallbackUI(error);
    }
});

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°
window.addEventListener('error', (event) => {
    console.error('ğŸ’¥ Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('ğŸ’¥ ĞĞµĞ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğ¹ Promise:', event.reason);
});

export default app;